name: Full Pipeline

on:
  workflow_dispatch:  # Allow manual trigger

jobs:
  pipeline:
    name: Run Full Pipeline
    runs-on: ubuntu-latest
    steps:
      - name: Run Infrastructure workflow
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh workflow run infra.yml --repo vmisson/azure-region-bench
          sleep 10
          RUN_ID=$(gh run list --workflow=infra.yml --repo vmisson/azure-region-bench --limit 1 --json databaseId --jq '.[0].databaseId')
          gh run watch $RUN_ID --repo vmisson/azure-region-bench

      - name: Run Server workflows (France Central, North Europe, West Europe)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Trigger all three workflows
          gh workflow run francecentral.yml --repo vmisson/azure-region-bench
          gh workflow run northeurope.yml --repo vmisson/azure-region-bench
          gh workflow run westeurope.yml --repo vmisson/azure-region-bench
          sleep 10
          
          # Get run IDs for all three workflows
          RUN_ID_FC=$(gh run list --workflow=francecentral.yml --repo vmisson/azure-region-bench --limit 1 --json databaseId --jq '.[0].databaseId')
          RUN_ID_NE=$(gh run list --workflow=northeurope.yml --repo vmisson/azure-region-bench --limit 1 --json databaseId --jq '.[0].databaseId')
          RUN_ID_WE=$(gh run list --workflow=westeurope.yml --repo vmisson/azure-region-bench --limit 1 --json databaseId --jq '.[0].databaseId')
          
          # Wait for all three workflows to complete in parallel
          gh run watch $RUN_ID_FC --repo vmisson/azure-region-bench &
          gh run watch $RUN_ID_NE --repo vmisson/azure-region-bench &
          gh run watch $RUN_ID_WE --repo vmisson/azure-region-bench &
          wait

      - name: Run Client workflow
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh workflow run client.yml --repo vmisson/azure-region-bench
          sleep 10
          RUN_ID=$(gh run list --workflow=client.yml --repo vmisson/azure-region-bench --limit 1 --json databaseId --jq '.[0].databaseId')
          gh run watch $RUN_ID --repo vmisson/azure-region-bench

      - name: Wait 5 minutes
        run: sleep 300

      - name: Run Cleanup workflow
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh workflow run cleanup.yml --repo vmisson/azure-region-bench
